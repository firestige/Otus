# Otus Global Configuration
# All settings live under the `otus:` root key.
# See doc/config-design.md for full hierarchy and design rationale.

otus:
  # ────────────── Node Identity ──────────────
  node:
    ip: ""                            # Empty = auto-detect (ADR-023: env > auto-detect > error)
    hostname: ""                      # Empty = os.Hostname()
    tags:
      datacenter: "dc1"
      environment: "production"

  # ────────────── Local Control ──────────────
  control:
    socket: "/var/run/otus.sock"
    pid_file: "/var/run/otus.pid"

  # ────────────── Kafka Global Default (ADR-024) ──────────────
  # command_channel.kafka and reporters.kafka inherit brokers/sasl/tls from here.
  kafka:
    brokers:
      - "localhost:9092"
    sasl:
      enabled: false
      mechanism: "PLAIN"
      username: ""
      password: ""
    tls:
      enabled: false
      insecure_skip_verify: false

  # ────────────── Remote Command Channel ──────────────
  command_channel:
    enabled: false                    # Set true to enable Kafka command subscription
    type: "kafka"
    kafka:
      # brokers/sasl/tls inherited from otus.kafka; override here if needed
      topic: "otus-commands"
      response_topic: "otus-responses"  # Write command results here (ADR-029); empty = disabled
      group_id: ""                    # Empty = "otus-${hostname}"
      auto_offset_reset: "latest"
    command_ttl: "5m"                 # Reject commands older than this (ADR-026)

  # ────────────── Shared Reporter Connections ──────────────
  reporters:
    kafka:
      # brokers/sasl/tls inherited from otus.kafka; override here if needed
      compression: "snappy"           # none | gzip | snappy | lz4 | zstd
      max_message_bytes: 1048576

  # ────────────── Global Resources ──────────────
  resources:
    max_workers: 0                    # 0 = auto (GOMAXPROCS)

  # ────────────── Backpressure Control ──────────────
  backpressure:
    pipeline_channel:
      capacity: 65536
      drop_policy: "tail"
    send_buffer:
      capacity: 16384
      drop_policy: "head"
      high_watermark: 0.8
      low_watermark: 0.3
    reporter:
      send_timeout: "3s"
      max_retries: 1

  # ────────────── Core Decoder ──────────────
  core:
    decoder:
      tunnel:
        vxlan: false
        gre: false
        geneve: false
        ipip: false
      ip_reassembly:
        timeout: "30s"
        max_fragments: 10000

  # ────────────── Prometheus Metrics ──────────────
  metrics:
    enabled: true
    listen: ":9091"
    path: "/metrics"

  # ────────────── Logging ──────────────
  log:
    level: "info"                     # debug | info | warn | error
    format: "json"                    # json | text
    outputs:
      file:
        enabled: true
        path: "/var/log/otus/otus.log"
        rotation:
          max_size_mb: 100            # ADR-025: numeric, unit in field name
          max_age_days: 30
          max_backups: 5
          compress: true
      loki:
        enabled: false
        endpoint: "http://loki:3100/loki/api/v1/push"
        labels:
          app: "otus"
          env: "production"
        batch_size: 100
        batch_timeout: "1s"

